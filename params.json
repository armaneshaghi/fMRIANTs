{"name":"Fmriants","tagline":"Minimal fMRI pre-processing with ANTS","body":"fMRIANTs\r\n========\r\n\r\nMinimal fMRI pre-processing with ANTS\r\n\r\nLet's first define some data and create an average (target) image.\r\n```\r\nfmri=data/bold.nii.gz\r\nnm=data/AFFINE\r\nref=${nm}_avg.nii.gz\r\nantsMotionCorr -d 3 -a $fmri -o $ref\r\n```\r\n\r\nThe variable `$ref` is the target image (fixed image) to which we will motion\r\ncorrect.\r\n\r\nLet's do affine motion correction first.\r\n```\r\nantsMotionCorr  -d 3 \\\r\n-o [ ${nm}, ${nm}.nii.gz,${nm}_avg.nii.gz] \\\r\n-m MI[${ref}, ${fmri}, 1 , 32 , Regular, 0.1  ] \\\r\n-t Affine[ 0.1 ] -u 1 -e 1 -s 1x0 -f 2x1 \\\r\n-i 15x3 -n 3  -w 1\r\n```\r\nThis is a 'fast' example - you might change `-i` parameters\r\nto something larger and `Regular, 0.1` to `Regular, 0.2` for 'real' data.\r\n\r\nThe parameter `-w 1` means write out the displacement field.  This will\r\nwrite a 4D displacement field that captures the affine induced motion\r\nat each voxel.  This can be used to concatenate space-time transformations\r\nor to control for motion, statistically, in a spatially varying way.\r\n\r\nNow we create a 4D target image for 4D motion deformable motion correction.\r\nFirst, parse the header information to find out the number of time points.\r\n```\r\nhislice=`PrintHeader $fmri | grep Dimens | cut -d ',' -f 4 | cut -d ']' -f 1`\r\ntr=`PrintHeader $fmri | grep \"Voxel Spac\" | cut -d ',' -f 4 | cut -d ']' -f 1`\r\n```\r\n\r\nReplicate the fixed 3D image `hislice` times to make a new 4D fixed image.\r\n```\r\nfxd=${nm}_fixed.nii.gz\r\nImageMath 3 $fxd ReplicateImage ${nm}_avg.nii.gz $hislice $tr 0\r\n```\r\n\r\nFinally, run SyN to map the time series to this fixed space.\r\n```\r\ntx=SyN[0.1,3,0.0] # critical parameters (though others matter too)\r\nantsRegistration --dimensionality 4 -f 1 -r ${nm}Warp.nii.gz \\\r\n      --output   [${nm}_,${nm}Warped.nii.gz] \\\r\n      --interpolation Linear --use-histogram-matching 1 \\\r\n      --winsorize-image-intensities [0.005,0.995] --transform $tx \\\r\n      --metric meansquares[${fxd},$fmri,1] \\\r\n      --convergence [15x2,1e-6,4] --shrink-factors 2x1 \\\r\n      --smoothing-sigmas 1x0vox --restrict-deformation 1x1x1x0\r\n```\r\nThe parameter `--restrict-deformation 1x1x1x0` prevents deformation across time.\r\n\r\nFinally, we generate a 3D transformation to a template then replicate these maps s.t. they can be applied to the original 4D dataset.  This is a useful\r\nexample of how ANTs works, in general, to minimize the number of interpolations\r\nthat one must apply to the data.\r\n```\r\nantsRegistrationSyNQuick.sh -d 3 -f data/template.nii.gz -m ${nm}_avg.nii.gz \\\r\n  -o ${nm}_diff -t s\r\n```\r\n\r\nUse `antsApplyTransforms` to combine the displacement field and affine matrix\r\ninto a single concatenated transformation stored as a displacement field.\r\n```\r\n# collapse the transformations to a displacement field\r\nantsApplyTransforms -d 3 -o [${nm}_diffCollapsedWarp.nii.gz,1] \\\r\n  -t ${nm}_diff1Warp.nii.gz -t ${nm}_diff0GenericAffine.mat \\\r\n  -r data/template.nii.gz\r\n```\r\n\r\nReplicate the 3D template to 4D and apply all the transformations to the\r\noriginal BOLD data.\r\n```\r\nImageMath 3 ${nm}_diff4DCollapsedWarp.nii.gz ReplicateDisplacement \\\r\n  ${nm}_diffCollapsedWarp.nii.gz $hislice $tr 0\r\nImageMath 3 data/template_replicated.nii.gz ReplicateImage \\\r\n  data/template.nii.gz $hislice $tr 0\r\n# apply to original bold\r\nantsApplyTransforms -d 4 -o ${nm}_bold2template.nii.gz \\\r\n  -t ${nm}_diff4DCollapsedWarp.nii.gz -t ${nm}_0Warp.nii.gz  \\\r\n  -r data/template_replicated.nii.gz -i ${nm}Warped.nii.gz\r\n```\r\n\r\nNext you can run the CompCor command to estimate physiological nuisance variables.\r\n\r\n```\r\n#\r\n# CompCor needs a mask --- you can get the mask by (might need to alter the value 200 up or down)\r\n#\r\nThresholdImage 3  data/AFFINE_avg.nii.gz data/mask.nii.gz 200 1.e9\r\nImageMath 3 data/mask.nii.gz ME data/mask.nii.gz 1\r\nImageMath 3 data/mask.nii.gz GetLargestComponent data/mask.nii.gz\r\nImageMath 3 data/mask.nii.gz MD data/mask.nii.gz 2\r\nImageMath 3 data/mask.nii.gz ME data/mask.nii.gz 1\r\n# you may alternatively run CompCor on the motion-corrected data\r\nImageMath 4 data/OUT.nii.gz CompCorrAuto data/bold.nii.gz data/mask.nii.gz 6\r\n#\r\n```\r\n\r\nFor use in context with T1 processing : see\r\n\r\n[NeuroBattery](http://jeffduda.github.io/NeuroBattery/)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}